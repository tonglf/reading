## 第 4 章  Function 语意学（The Semantics of Function）

### 4.1  Member 的各种调用方式

C++ 成员函数的三种类型：非静态、虚拟、静态。

#### Nonstatic Member Functions（非静态成员函数）

C++ 的设计准则之一就是：nonstatic member function 至少必须和一般的 nonmember function 有相同的效率。

**nonstatic member function 在调用时，会被转化为 nonmember function 的形式**，转化步骤如下：

1. 改写函数的 signature（译注:意指函数原型）以安插一个额外的参数到 member function 中，用以提供一个存取管道，使 class object 得以调用该函数。该额外参数被称为 this 指针：

    ```cpp
    // non-const nonstatic member 之增长过程 
    Point3d
    Point3d::magnitude(Point3d *const this)
    ```

    如果 member function 是 const，则变成：

    ```cpp
    // const nonstatic member 之扩张过程
    Point3d
    Point3d::magnitude(const Point3d *const this)
    ```

2. 将每一个 “对 nonstatic data member 的存取操作” 改为经由 this 指针来存取：

    ```cpp
    return sqrt(this->_x * this->_x + this->_y * this->_y + this->_z * this->_z);
    ```

3. 将 member function 重新写成一个外部函数，对函数名称进行 “mangling” 处理，使它在程序中成为独一无二的语汇:

    ```cpp
    extern magnitude__7Point3dFv(register Point3d *const this) ;
    ```

    现在这个函数已经被转换好了，而其每一个调用操作也都必须转换．于是:

    ```cpp
    obj.magnitude();
    // 变成了:
    magnitude__7Point3dFv(&obj);
    
    ptr->magnitude();
    // 变成了:
    magnitude__7Point3dFv(ptr);
    ```

函数内部被转化为：

```cpp
// 以下描述“named return value函数”的内部转化
// 使用C++伪码
void
normalize_7Point3dFv(register const Point3d *const this,Point3d &___result)
{
	register float mag = this->magnitude();
	// default constructor
	__result.Point3d::Point3d();
    
    __result._x = this->_x/mag;
    __result._y = this->_y/mag;
    __result._z = this->_z/mag;
	return;
}
```

**名称的特殊处理**

> 成员函数被转化为非成员函数，函数该如何命名呢？

- 一般而言，member 的名称前面会被加上 class 名称，形成独一无二的命名。

- 为避免多个重载函数实体拥有相同的名称，让它们独一无二，名称中再加上它们的参数链表（可以从函数原型中参考得到)。



#### Virtual Member Functions（虚拟成员函数）

如果 normalize() 是一个 virtual member function，那么以下的调用：

```cpp
ptr->normalize();
```

将会被内部转化为：

```cpp
*ptr->vptr[1])(ptr);
```

通过虚函数表、虚函数指针进行调用。



#### Static Member Functions（静态成员函数）

Static member functions 的主要特性就是它没有 this 指针。以下的次要特性统统根源于其主要特性：

- 它不能够直接存取其 class 中的 nonstatic members；
- 它不能够被声明为 const、 volatile 或 virtual；
- 它不需要经由 class object 才被调用

Static Member Functions 也被转化为一般的 nonmember 函数调用，如下：

```cpp
obj.normalize();
ptr->normalize();
// 转化为：
normalize_7Point3dsFv();
normalize_7Point3dsFV();
```

Static member function 由于缺乏 this 指针，因此差不多等同于 nonmember function。

**注意：**

如果 class 的设计者把 static data member 声明为 nonpublic（这一直被视为是一种好的习惯），那么他就必须提供一个或多个 member functions 来存取该 member。



### 4.2  Virtual Member Function （虚拟成员函数）



**多重继承下的 Virtual Function**



**虚拟继承下的 Virtual Function**



### 4.3  函数的效能





### 4.4  指向 Member Function 的指针（Pointer-to-Member Functions）





### 4.5  Inline Functions



### 本章小结